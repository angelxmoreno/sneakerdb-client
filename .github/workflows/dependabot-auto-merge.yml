name: Dependabot Auto Merge

on:
  workflow_run:
    workflows:
      - Node.js CI with Codecov
    types:
      - completed

jobs:
  automerge:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Merge Dependabot PR
        uses: actions/github-script@v7
        with:
          script: |
            const pullRequest = context.payload.workflow_run.pull_requests[0];
            if (!pullRequest) {
              core.info('No PR associated with this workflow run.');
              return;
            }

            const { owner, repo } = context.repo;
            const pull_number = pullRequest.number;

            const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number });
            if (pr.user?.login !== 'dependabot[bot]') {
              core.info('Not a Dependabot PR. Skipping.');
              return;
            }

            if (pr.state !== 'open' || pr.draft) {
              core.info(`PR #${pull_number} is not open or is a draft.`);
              return;
            }

            if (pr.mergeable_state === 'dirty') {
              core.info(`PR #${pull_number} has conflicts. Manual intervention required.`);
              return;
            }

            await github.rest.pulls.merge({
              owner,
              repo,
              pull_number,
              merge_method: 'squash'
            });
            core.notice(`Dependabot PR #${pull_number} merged after successful checks.`);
